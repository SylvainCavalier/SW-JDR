<div class="container-fluid mt-4 apprentice-show">
  <%= back_link(apprentices_path) %>

  <!-- En-tête avec nom et alignement -->
  <div class="apprentice-header text-center mb-4">
    <div class="row justify-content-center">
      <div class="col-12 col-lg-10">
        <div class="d-flex justify-content-center align-items-center mb-3">
          <div class="force-indicator me-3" style="background-color: <%= @apprentice.alignment_color %>;">
            <% if @apprentice.force_alignment == "Côté Obscur" %>
              <i class="fa-solid fa-moon"></i>
            <% elsif @apprentice.force_alignment == "Côté Lumineux" %>
              <i class="fa-solid fa-sun"></i>
            <% else %>
              <i class="fa-solid fa-yin-yang"></i>
            <% end %>
          </div>
          <h1 class="text-warning mb-0"><%= @apprentice.jedi_name %></h1>
        </div>
        <p class="text-secondary mb-0">
          Apprenti de <strong class="text-info"><%= @apprentice.user.username %></strong>
          <span class="mx-2">|</span>
          <span class="text-light"><%= @apprentice.speciality %></span>
        </p>
      </div>
    </div>
  </div>

  <div class="row justify-content-center">
    <div class="col-12 col-lg-10">
      <div class="row">
        <!-- Colonne gauche : Identité et stats -->
        <div class="col-12 col-md-4 mb-4">
          <!-- Carte d'identité -->
          <div class="card bg-dark text-light border-info mb-4">
            <div class="card-header bg-info bg-opacity-25">
              <h5 class="mb-0"><i class="fa-solid fa-id-card me-2"></i>Identité</h5>
            </div>
            <div class="card-body text-center">
              <% if @apprentice.pet.image.attached? %>
                <%= image_tag @apprentice.pet.image.variant(resize_to_limit: [180, 180]), class: "rounded-circle apprentice-avatar mb-3" %>
              <% else %>
                <div class="apprentice-placeholder-lg mb-3">
                  <i class="fa-solid fa-user fa-4x"></i>
                </div>
              <% end %>
              
              <ul class="list-unstyled">
                <li class="mb-2">
                  <span class="text-secondary">Nom d'origine :</span>
                  <span class="text-light"><%= @apprentice.pet.name %></span>
                </li>
                <li class="mb-2">
                  <span class="text-secondary">Race :</span>
                  <span class="text-light"><%= @apprentice.pet.race %></span>
                </li>
                <li class="mb-2">
                  <span class="text-secondary">Style de sabre :</span>
                  <span class="text-warning"><%= @apprentice.saber_style || "Non défini" %></span>
                </li>
              </ul>
            </div>
          </div>

          <!-- Carte Potentiel de la Force -->
          <div class="card bg-dark text-light border-success mb-4">
            <div class="card-header bg-success bg-opacity-25">
              <h5 class="mb-0"><i class="fa-solid fa-dna me-2"></i>Potentiel de la Force</h5>
            </div>
            <div class="card-body">
              <div class="midi-chlorian-display text-center mb-3">
                <span class="midi-count"><%= number_with_delimiter(@apprentice.midi_chlorians) %></span>
                <span class="midi-label">midi-chloriens</span>
              </div>
              <div class="text-center">
                <span class="badge bg-success"><%= @apprentice.midi_chlorian_potential %></span>
              </div>
            </div>
          </div>

          <!-- Carte Alignement -->
          <div class="card bg-dark text-light border-secondary">
            <div class="card-header" style="background-color: <%= @apprentice.alignment_color %>25;">
              <h5 class="mb-0" style="color: <%= @apprentice.alignment_color %>;">
                <i class="fa-solid fa-balance-scale me-2"></i>Alignement
              </h5>
            </div>
            <div class="card-body">
              <!-- Barre d'alignement -->
              <div class="force-alignment-bar">
                <div class="d-flex justify-content-between mb-1">
                  <span class="text-danger small"><i class="fa-solid fa-moon"></i></span>
                  <span class="text-info small"><i class="fa-solid fa-sun"></i></span>
                </div>
                <div class="progress" style="height: 25px;">
                  <% alignment_percent = ((@apprentice.side + 100) / 200.0 * 100).round %>
                  <div class="progress-bar" 
                       role="progressbar" 
                       style="width: 100%; background: linear-gradient(to right, #E53935 0%, #FFD54F 50%, #4FC3F7 100%);"
                       aria-valuenow="<%= @apprentice.side %>" 
                       aria-valuemin="-100" 
                       aria-valuemax="100">
                  </div>
                  <div class="alignment-marker" style="left: <%= alignment_percent %>%;">
                    <div class="marker-dot" style="background-color: <%= @apprentice.alignment_color %>;"></div>
                  </div>
                </div>
                <div class="text-center mt-2">
                  <span class="badge fs-6" style="background-color: <%= @apprentice.alignment_color %>;">
                    <%= @apprentice.force_alignment %> (<%= @apprentice.side > 0 ? "+#{@apprentice.side}" : @apprentice.side %>)
                  </span>
                </div>
              </div>

            </div>
          </div>
        </div>

        <!-- Colonne droite : Caractéristiques et Compétences -->
        <div class="col-12 col-md-8">
          <!-- Caractéristiques -->
          <div class="card bg-dark text-light border-warning mb-4">
            <div class="card-header bg-warning bg-opacity-25">
              <h5 class="mb-0 text-warning"><i class="fa-solid fa-chart-bar me-2"></i>Caractéristiques</h5>
            </div>
            <div class="card-body">
              <div class="row">
                <% @apprentice.apprentice_caracs.includes(:carac).each do |ac| %>
                  <div class="col-6 col-md-4 mb-3">
                    <div class="carac-box">
                      <span class="carac-name"><%= ac.carac.name %></span>
                      <span class="carac-value"><%= ac.mastery %>D<% if ac.bonus > 0 %>+<%= ac.bonus %><% end %></span>
                    </div>
                  </div>
                <% end %>
              </div>
            </div>
          </div>

          <!-- Compétences -->
          <div class="card bg-dark text-light border-info">
            <div class="card-header bg-info bg-opacity-25">
              <h5 class="mb-0 text-info"><i class="fa-solid fa-list-check me-2"></i>Compétences</h5>
            </div>
            <div class="card-body">
              <% @grouped_skills.each do |carac_name, skills| %>
                <% next if skills.empty? %>
                <div class="skill-group mb-4">
                  <h6 class="<%= carac_name == 'Spécial' ? 'text-warning' : 'text-success' %> mb-3" 
                      role="button" 
                      data-bs-toggle="collapse" 
                      data-bs-target="#skills-<%= carac_name.parameterize %>"
                      aria-expanded="true">
                    <i class="fa-solid fa-chevron-down me-2"></i><%= carac_name %>
                  </h6>
                  <div class="collapse show" id="skills-<%= carac_name.parameterize %>">
                    <table class="table table-dark table-hover table-sm">
                      <thead>
                        <tr class="text-secondary">
                          <th>Compétence</th>
                          <th class="text-center">Maîtrise</th>
                          <th class="text-center">Bonus</th>
                          <th class="text-center">
                            <i class="fa-solid fa-dice" title="Lancer"></i>
                          </th>
                        </tr>
                      </thead>
                      <tbody>
                        <% skills.each do |as| %>
                          <tr>
                            <td><%= as.skill.name %></td>
                            <td class="text-center"><%= as.mastery %>D</td>
                            <td class="text-center">+<%= as.bonus %></td>
                            <td class="text-center">
                              <i class="fa-solid fa-dice text-info" 
                                 style="cursor: pointer;"
                                 data-bs-toggle="modal" 
                                 data-bs-target="#diceModal"
                                 data-dice-count="<%= as.mastery %>"
                                 data-dice-bonus-value="<%= as.bonus %>"
                                 data-action="click->dice#prepareRoll"
                                 title="Lancer <%= as.mastery %>D+<%= as.bonus %>"></i>
                            </td>
                          </tr>
                        <% end %>
                      </tbody>
                    </table>
                  </div>
                </div>
              <% end %>
            </div>
          </div>
        </div>
      </div>

      <!-- Boutons d'action -->
      <div class="d-flex justify-content-center gap-3 mt-4 mb-4">
        <%= link_to apprentices_path, class: "btn btn-outline-secondary" do %>
          <i class="fa-solid fa-arrow-left me-2"></i>Retour
        <% end %>
        
        <% if @apprentice.user == current_user || current_user.group.name == "MJ" %>
          <%= link_to edit_apprentice_path(@apprentice), class: "btn btn-warning" do %>
            <i class="fa-solid fa-edit me-2"></i>Modifier
          <% end %>
        <% end %>
      </div>
    </div>
  </div>
</div>

<style>
  .force-alignment-bar {
    position: relative;
  }
  
  .force-alignment-bar .progress {
    position: relative;
    overflow: visible;
  }
  
  .alignment-marker {
    position: absolute;
    top: 50%;
    transform: translate(-50%, -50%);
    z-index: 10;
  }
  
  .marker-dot {
    width: 16px;
    height: 16px;
    border-radius: 50%;
    border: 3px solid white;
    box-shadow: 0 0 10px rgba(0,0,0,0.5);
  }
</style>

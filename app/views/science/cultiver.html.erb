<div class="container mt-4" data-controller="embryo">
  <h1 class="text-center text-success mb-4">üß¨ Culture d'embryons</h1>

  <%= link_to "Retour", genetique_dashboard_path, class: "btn btn-outline-secondary mt-4 go-back-two" %>

  <!-- Ressources disponibles -->
  <div class="row justify-content-center mb-4">
    <div class="col-auto">
      <div class="card bg-dark text-light border-success">
        <div class="card-body d-flex align-items-center gap-3">
          <div class="resource-item">
            <i class="fa-solid fa-flask text-info"></i>
            <span>√âprouvettes: </span>
            <strong data-embryo-target="eprouvettes"><%= @eprouvettes %></strong>
          </div>
          <div class="vr"></div>
          <div class="resource-item">
            <i class="fa-solid fa-dna text-warning"></i>
            <span>Mati√®re organique: </span>
            <strong data-embryo-target="matiere"><%= @matiere_organique %></strong>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <!-- Formulaire de cr√©ation -->
    <div class="col-lg-5 mb-4">
      <div class="card bg-dark text-light border-success h-100">
        <div class="card-header bg-success text-white">
          <h5 class="mb-0"><i class="fa-solid fa-plus-circle me-2"></i>Cr√©er un nouvel embryon</h5>
        </div>
        <div class="card-body">
          <%= form_with scope: :embryo, local: false, data: { action: "submit->embryo#createEmbryo" } do |f| %>
            
            <div class="mb-3">
              <%= f.label :creature_type, "Type de cr√©ature", class: "form-label" %>
              <%= f.select :creature_type, 
                  @creature_types.keys.map { |k| [k.humanize.capitalize, k] },
                  { prompt: "S√©lectionnez un type..." },
                  class: "form-select bg-secondary text-light border-success",
                  data: { embryo_target: "creatureType", action: "change->embryo#updatePreview" } %>
            </div>

            <div class="mb-3">
              <%= f.label :name, "Nom de l'embryon", class: "form-label" %>
              <%= f.text_field :name, 
                  class: "form-control bg-secondary text-light border-success", 
                  placeholder: "Ex: Alpha-X7",
                  maxlength: 30,
                  required: true %>
            </div>

            <div class="mb-3">
              <%= f.label :race, "Race / Esp√®ce (roleplay)", class: "form-label" %>
              <%= f.text_field :race, 
                  class: "form-control bg-secondary text-light border-success", 
                  placeholder: "Ex: Nexu de Cholganna",
                  maxlength: 50 %>
            </div>

            <div class="mb-3">
              <%= f.label :gender, "Genre", class: "form-label" %>
              <%= f.select :gender, 
                  [["M√¢le", "m√¢le"], ["Femelle", "femelle"], ["Ind√©termin√©", "ind√©termin√©"]],
                  { prompt: "S√©lectionnez..." },
                  class: "form-select bg-secondary text-light border-success" %>
            </div>

            <!-- Aper√ßu des stats -->
            <div class="card bg-secondary mb-3" data-embryo-target="preview" style="display: none;">
              <div class="card-header bg-info text-dark">
                <small><i class="fa-solid fa-chart-bar me-1"></i>Aper√ßu des caract√©ristiques de base</small>
              </div>
              <div class="card-body p-2">
                <div class="row small">
                  <div class="col-6">
                    <p class="mb-1"><i class="fa-solid fa-heart text-danger"></i> PV: <span data-embryo-target="previewHp">-</span></p>
                    <p class="mb-1"><i class="fa-solid fa-sword text-warning"></i> D√©g√¢ts: <span data-embryo-target="previewDamage">-</span></p>
                    <p class="mb-1"><i class="fa-solid fa-shield text-primary"></i> R√©s. Corp: <span data-embryo-target="previewResist">-</span></p>
                  </div>
                  <div class="col-6">
                    <p class="mb-1"><i class="fa-solid fa-bullseye text-success"></i> Pr√©cision: <span data-embryo-target="previewPrecision">-</span></p>
                    <p class="mb-1"><i class="fa-solid fa-running text-info"></i> Vitesse: <span data-embryo-target="previewSpeed">-</span></p>
                    <p class="mb-1"><i class="fa-solid fa-person-running text-light"></i> Esquive: <span data-embryo-target="previewDodge">-</span></p>
                  </div>
                </div>
              </div>
            </div>

            <%= f.submit "Cultiver l'embryon", 
                class: "btn btn-outline-success w-100",
                data: { embryo_target: "submitBtn" } %>
          <% end %>
        </div>
      </div>
    </div>

    <!-- Liste des embryons stock√©s -->
    <div class="col-lg-7 mb-4">
      <div class="card bg-dark text-light border-info h-100">
        <div class="card-header bg-info text-dark">
          <h5 class="mb-0"><i class="fa-solid fa-boxes-stacked me-2"></i>Embryons stock√©s (<span data-embryo-target="embryoCount"><%= @embryos.count %></span>)</h5>
        </div>
        <div class="card-body" style="max-height: 500px; overflow-y: auto;">
          <% if @embryos.any? %>
            <div class="table-responsive">
              <table class="table table-dark table-hover table-sm">
                <thead>
                  <tr>
                    <th>Nom</th>
                    <th>Type</th>
                    <th>Race</th>
                    <th>Genre</th>
                    <th>PV</th>
                    <th>Arme</th>
                  </tr>
                </thead>
                <tbody data-embryo-target="embryoList">
                  <% @embryos.each do |embryo| %>
                    <tr>
                      <td><strong><%= embryo.name %></strong></td>
                      <td><span class="badge bg-success"><%= embryo.creature_type.humanize %></span></td>
                      <td><%= embryo.race || "-" %></td>
                      <td><%= embryo.gender&.capitalize || "-" %></td>
                      <td><%= embryo.hp_max %></td>
                      <td><%= embryo.weapon || "-" %></td>
                    </tr>
                  <% end %>
                </tbody>
              </table>
            </div>
          <% else %>
            <div class="text-center text-muted py-4" data-embryo-target="emptyMessage">
              <i class="fa-solid fa-flask fa-3x mb-3"></i>
              <p>Aucun embryon stock√© pour le moment.</p>
              <p class="small">Cr√©ez votre premier embryon en utilisant le formulaire ci-contre.</p>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de r√©sultat -->
  <div class="modal fade" id="embryoResultModal" tabindex="-1" data-embryo-target="resultModal">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content bg-dark text-light border-success">
        <div class="modal-header" data-embryo-target="modalHeader">
          <h5 class="modal-title" data-embryo-target="modalTitle">R√©sultat</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body text-center">
          <!-- Image de r√©sultat -->
          <div class="mb-3" data-embryo-target="resultImage"></div>
          <div class="dice-result-display mb-3">
            <span class="display-1" data-embryo-target="diceResult">?</span>
            <p class="text-muted">Jet de d√© (1D12)</p>
          </div>
          <p class="lead" data-embryo-target="resultMessage"></p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Lien retour -->
  <div class="text-center mt-4">
    <%= link_to genetique_dashboard_path, class: "btn btn-outline-secondary" do %>
      <i class="fa-solid fa-arrow-left me-2"></i>Retour au Dashboard G√©n√©tique
    <% end %>
  </div>
</div>

<script>
  // Donn√©es des types de cr√©atures pour l'aper√ßu JavaScript
  window.creatureTypes = <%= raw @creature_types.to_json %>;
</script>

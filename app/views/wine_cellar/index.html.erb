<div class="container-fluid mt-4" 
     data-controller="accordion-persist wine-cellar"
     data-wine-cellar-add-url-value="<%= add_bottle_wine_cellar_path %>"
     data-wine-cellar-remove-url-value="<%= remove_bottle_wine_cellar_path %>">
  <!-- Titre -->
  <h1 class="text-success text-center mb-4">
    <i class="fa-solid fa-wine-bottle me-2"></i>Cave à Vin
  </h1>

  <!-- Onglets -->
  <ul class="nav nav-tabs mb-4 justify-content-center" id="wineCellarTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="drinks-list-tab" data-bs-toggle="tab" data-bs-target="#drinks-list" type="button" role="tab" aria-controls="drinks-list" aria-selected="true">
        <i class="fa-solid fa-list me-2"></i>Catalogue des Alcools
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="cellar-tab" data-bs-toggle="tab" data-bs-target="#cellar" type="button" role="tab" aria-controls="cellar" aria-selected="false">
        <i class="fa-solid fa-warehouse me-2"></i>Ma Cave
      </button>
    </li>
  </ul>

  <!-- Contenu des onglets -->
  <div class="tab-content" id="wineCellarTabsContent">
    
    <!-- Onglet Liste des Alcools -->
    <div class="tab-pane fade show active" id="drinks-list" role="tabpanel" aria-labelledby="drinks-list-tab">
      <div class="mb-2 p-4 skill-section">
        <h3 class="text-white mb-2">
          Alcools de la Galaxie
        </h3>

        <table class="table table-dark table-hover rounded-3 overflow-hidden">
          <thead>
            <tr class="text-success">
              <th class="px-4">Nom</th>
              <th class="text-center px-4">Planète</th>
              <th class="text-center px-4">Degré</th>
              <th class="text-center px-4">Prix</th>
              <th class="px-4">Description</th>
            </tr>
          </thead>
          <tbody>
            <% @drinks_data.sort_by { |d| d['name'] }.each do |drink| %>
              <% is_discovered = @discovered_drinks.include?(drink['id']) %>
              <tr class="<%= 'opacity-50' unless is_discovered %>">
                <td class="px-4">
                  <% if is_discovered %>
                    <span class="text-light"><%= drink['name'] %></span>
                  <% else %>
                    <span><%= drink['name'] %></span>
                    <i class="fa-solid fa-lock ms-2 text-muted small"></i>
                  <% end %>
                </td>
                <td class="text-center px-4">
                  <% if is_discovered %>
                    <span class="text-light"><%= drink['planet'] %></span>
                  <% else %>
                    <span>???</span>
                  <% end %>
                </td>
                <td class="text-center px-4">
                  <% if is_discovered %>
                    <span class="text-light"><%= drink['abv'] %>%</span>
                  <% else %>
                    <span>???</span>
                  <% end %>
                </td>
                <td class="text-center px-4">
                  <% if is_discovered %>
                    <span class="text-light"><%= drink['price'] %> ¢</span>
                  <% else %>
                    <span>???</span>
                  <% end %>
                </td>
                <td class="px-4">
                  <% if is_discovered %>
                    <small class="text-light"><%= drink['description'] %></small>
                  <% else %>
                    <small class="fst-italic">Non découvert</small>
                  <% end %>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>

      <!-- Statistiques -->
      <div class="text-center my-4">
        <% total_drinks = @drinks_data.size %>
        <% total_discovered = @discovered_drinks.size %>
        <% percentage = total_drinks > 0 ? ((total_discovered.to_f / total_drinks) * 100).round : 0 %>
        <p class="text-success">
          <i class="fa-solid fa-trophy me-2"></i>
          <strong><%= total_discovered %> / <%= total_drinks %></strong> alcools découverts (<%= percentage %>%)
        </p>
        <div class="progress mx-auto" style="max-width: 400px; height: 10px;">
          <div class="progress-bar bg-success" role="progressbar" style="width: <%= percentage %>%;" aria-valuenow="<%= percentage %>" aria-valuemin="0" aria-valuemax="100"></div>
        </div>
      </div>
    </div>

    <!-- Onglet Cave à Vin -->
    <div class="tab-pane fade" id="cellar" role="tabpanel" aria-labelledby="cellar-tab">
      <% if @user_drinks.any? %>
        <div class="mb-2 p-4 skill-section">
          <h3 class="text-white mb-2">
            <i class="fa-solid fa-wine-glass me-2"></i>Mes Bouteilles
            <small>(<%= @user_drinks.sum(&:quantity) %> bouteilles)</small>
          </h3>

          <table class="table table-dark table-hover rounded-3 overflow-hidden">
            <thead>
              <tr class="text-success">
                <th class="px-4">Nom</th>
                <th class="text-center px-4">Qté</th>
                <th class="text-center px-4">Planète</th>
                <th class="text-center px-4">Prix</th>
                <th class="px-4">Description</th>
                <th class="text-center px-4">Actions</th>
              </tr>
            </thead>
            <tbody>
              <% @user_drinks.each do |user_drink| %>
                <% drink_data = @drinks_data.find { |d| d['id'] == user_drink.inventory_object.catalog_id } %>
                <tr id="wine_cellar_drink_<%= user_drink.inventory_object.id %>">
                  <td class="px-4">
                    <span class="text-light"><%= user_drink.inventory_object.name %></span>
                  </td>
                  <td class="text-center px-4">
                    <span class="badge bg-success" id="quantity_<%= user_drink.inventory_object.id %>"><%= user_drink.quantity %></span>
                  </td>
                  <td class="text-center px-4">
                    <span class="text-light"><%= drink_data ? drink_data['planet'] : 'N/A' %></span>
                  </td>
                  <td class="text-center px-4">
                    <span class="text-light"><%= user_drink.inventory_object.price %> ¢</span>
                  </td>
                  <td class="px-4">
                    <small class="text-light"><%= user_drink.inventory_object.description&.truncate(80) %></small>
                  </td>
                  <td class="text-center px-4">
                    <div class="btn-group btn-group-sm" role="group">
                      <button type="button" class="btn btn-outline-success btn-sm" 
                              data-action="click->wine-cellar#add"
                              data-drink-id="<%= user_drink.inventory_object.catalog_id %>"
                              data-inventory-object-id="<%= user_drink.inventory_object.id %>"
                              title="Ajouter">
                        <i class="fa-solid fa-plus"></i>
                      </button>
                      <button type="button" class="btn btn-outline-danger btn-sm" 
                              data-action="click->wine-cellar#remove"
                              data-drink-id="<%= user_drink.inventory_object.catalog_id %>"
                              data-inventory-object-id="<%= user_drink.inventory_object.id %>"
                              title="Retirer">
                        <i class="fa-solid fa-minus"></i>
                      </button>
                    </div>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>

        <!-- Valeur totale -->
        <div class="text-center mt-3">
          <% total_value = @user_drinks.sum { |ud| ud.quantity * ud.inventory_object.price } %>
          <p class="text-success">
            <i class="fa-solid fa-coins me-2"></i>
            Valeur totale de la cave : <strong><%= total_value %> crédits</strong>
          </p>
        </div>
      <% else %>
        <div class="mb-2 p-4 skill-section text-center">
          <i class="fa-solid fa-wine-glass-empty fa-3x mb-3 text-success"></i>
          <p>Votre cave à vin est vide pour le moment.</p>
          <p>Les bouteilles que vous obtiendrez apparaîtront ici.</p>
        </div>
      <% end %>
    </div>
  </div>

  <%= back_link(root_path) %>
</div>
